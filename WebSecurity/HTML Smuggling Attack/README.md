<div dir="rtl">

# نویسندگان:
  فاطمه شاه‌علی، فاطمه بحرانی
# معرفی اجمالی حمله HTML Smuggling
تکنیک HTML Smuggling، یک تکنیک تحویل بدافزار است که از ویژگی‌های قانونی HTML5 و جاوا اسکریپت برای نفوذ استفاده می‌کند.
  این تکنیک به طور رو به رشدی در عملیات‌های ایمیلی که بدافزارهای بانکی، تروجان‌های دسترسی از راه دور (RAT) و سایر حمله‌های مرتبط با payload را به طور هدفمند مستقر می‌کنند، استفاده می‌شود.
  قابل ذکر است، این تکنیک در یک عملیات spear-phishing توسط گروه تهدید NOBELIUM در ماه می مشاهده شد. هم‌چنین اخیراً شاهد این بودیم که این تکنیک، تروجان‌های بانکی Mekotio و AsyncRAT/NJRAT و Trickbot را ارائه می‌دهد؛
  بدافزارهایی که مهاجمان از آن‌ها برای به دست آوردن کنترل دستگاه‌های آسیب‌دیده و اجرای payload باج‌افزار و سایر تهدیدها بر روی این دستگاه‌ها استفاده می‌کنند.
  
  همانطور که از نام آن پیداست، HTML Smuggling  به مهاجم این امکان را می‌دهد که یک اسکریپت مخربِ رمزگذاری شده را در یک پیوست HTML یا صفحه وب «قاچاق» کند (جاسازی کند).
  هنگامی که یک کاربر هدف، آن فایل HTML را در مرورگر وب خود باز می‌کند،
  مرورگر اسکریپت مخرب را رمزگشایی می‌کند. در نتیجه‌ی این عمل، فایل مخرب payload را روی دستگاه میزبان سوار می‌کند. بنابراین،
  مهاجم به جای فرستادن یک فایل قابل اجرای مخرب به طور مستقیم از طریق یک شبکه، بدافزار را به صورت محلی پشت یک فایروال می‌سازد. تصویر پایین، شمای کلی طرح نفوذ را نشان می‌دهد:
  </br>
  <div align="center" style="text-align:center" >
  <img src="https://www.microsoft.com/security/blog/uploads/securityprod/2021/11/Fig1-HTML-smuggling-overview.png" width="60%" alt=""/>
</div>
  </br>
این تکنیک بسیار گریزان است؛ یعنی می‌تواند کنترل‌های امنیتیِ محیطیِ استاندارد، مانند پروکسی‌های وب و gatewayهای ایمیل را که اغلب فقط پیوست‌های مشکوک (مثلاً EXE، ZIP یا DOCX) یا ترافیک را بر اساس امضاها و الگوها بررسی می‌کنند، دور بزند.
از آنجایی که فایل‌های مخرب، تنها پس از بارگیری فایل HTML در نقطه پایانی از طریق مرورگر ایجاد می‌شوند، چیزی که برخی از راه‌حل‌های حفاظتی در ابتدا مشاهده می‌کنند، ترافیک بی‌خطر HTML و جاوا اسکریپت است که می‌تواند برای پنهان کردنِ هرچه بیشترِ هدف واقعی خود،
به صورت مبهم* ارائه شود.

*مبهم‌سازی جاوا اسکریپت، یک سلسله تبدیل روی کد است که کد JS ساده و خوانا را به یک نسخه اصلاح‌شده تبدیل می‌کند؛ به‌طوری که درک و مهندسی معکوس آن بسیار سخت است.

# چگونگی عملکرد HTML Smuggling
حمله HTML Smuggling از ویژگی‌های قانونی HTML5 و جاوا اسکریپت استفاده می‌کند که هر دو توسط همه‌ی مرورگرهای مدرن پشتیبانی می‌شوند تا فایل‌های مخرب را در پشت فایروال تولید کنند.
به طور خاص، HTML Smuggling از ویژگی «دانلود»HTML5  برای تگ‌های anchor و همچنین ایجاد و استفاده از JavaScript Blob  برای جمع‌آوری Payload دانلود شده در دستگاه آسیب‌دیده استفاده می‌کند.
در HTML5، زمانی که کاربر روی یک لینک کلیک می‌کند، ویژگی «دانلود» به یک فایل HTML اجازه می‌دهد به طور خودکار فایلی را که در تگ «href» ارجاع داده شده است دانلود کند. برای مثال، کد زیر به مرورگر دستور می‌دهد تا "malicious.docx" را از محل خود دانلود کرده و آن را به عنوان "safe.docx" در دستگاه ذخیره کند:

  </br>
  <div align="center" style="text-align:center" >
  <img src="https://github.com/F-Shahali/HTML-smuggling/blob/main/2.png" width="80%" alt=""/>
</div>
  </br>
تگ anchor و ویژگی "دانلود" یک فایل نیز معادل‌های خود را در کد جاوا اسکریپت دارند، همانطور که در زیر مشاهده می کنید:
</br>
  </br>
  <div align="center" style="text-align:center" >
  <img src="https://github.com/F-Shahali/HTML-smuggling/blob/main/3.png" width="80%" alt=""/>
</div>
  </br>
  
  استفاده از JavaScript Blobs به جنبه «قاچاق» این تکنیک می‌افزاید. یک جاوا اسکریپت Blob داده‌های رمزگذاری شده‌ی یک فایل را ذخیره می‌کند.
  این داده‌ها پس از ارسال به یک API جاوا اسکریپت که انتظار URL دارد، رمزگشایی می‌شود.
  این بدان معناست که به جای ارائه‌ی پیوند به یک فایل واقعی که کاربر باید به صورت دستی برای دانلود آن کلیک کند،
  می‌توان فایل مذکور را به صورت خودکار با استفاده از کدهای جاوا اسکریپت مانند موارد زیر دانلود و به صورت محلی  در سیستم هدف ساخت:
  </br>
  <div align="center" style="text-align:center" >
  <img src="https://github.com/F-Shahali/HTML-smuggling/blob/main/4.png" width="80%" alt=""/>
</div>
  </br>
  حملات امروزی از HTML Smuggling به دو صورت استفاده می‌کنند: پیوند به صفحه‌ی HTML Smuggling در پیام ایمیل قرار می‌گیرد یا خود صفحه به عنوان پیوست گنجانده می‌شود.
  بخش بعد نمونه‌هایی از تهدیدات واقعی را که اخیراً با استفاده از هر کدام از این روش‌ها مشاهده شده‌است، ارائه می‌دهد.
  
# مثال‌هایی از HTML Smuggling در دنیای واقعی
  در بعضی از حملات بدافزار بانکی از HTML smuggling استفاده شده‌است که در آن  برزیل، مکزیک، اسپانیا، پرو و پرتغال هدف قرار داده شده‌اند.
  در یکی از حمله‌های Mekotio (یک تروجان بانکی) مهاجمان ایمیل‌هایی را با یک پیوند مخرب ارسال کردند، همان طور که در تصویر زیر نشان داده شده است:
 </br>
  <div align="center" style="text-align:center" >
  <img src="https://www.microsoft.com/security/blog/uploads/securityprod/2021/11/Fig2-HTML-smuggling-Mekotio-campaign.png" width="60%" alt=""/>
</div>
  </br>
  یک شِمای کلی از این حمله را در شکل زیر مشاهده می‌کنید که توضیحات مربوطه، بعد از آن به طور جزئی‌تر بیان شده‌اند:
  </br>
  <div align="center" style="text-align:center" >
  <img src="https://www.microsoft.com/security/blog/uploads/securityprod/2021/11/Fig3-attack-chain-Mekotio-campaign.png" width="70%" alt=""/>
</div>
  </br>
  در این حمله، از وب سایت مخرب hxxp://poocardy[.]net/diretorio/ برای پیاده سازی تکنیک HTML Smuggling و حذف فایل دانلودکننده مخرب استفاده می‌شود (این لینک را باز نکنید!). تصویر زیر یک صفحه HTML Smuggling را هنگام رندر شدن در مرورگر نشان می‌دهد.
   </br>
  <div align="center" style="text-align:center" >
  <img src="https://www.microsoft.com/security/blog/uploads/securityprod/2021/11/Fig4-HTML-page.png" width="70%" alt=""/>
</div>
  همان طور که ملاحظه می‌کنید، تگ "href" به یک JavaScript Blob از نوع octet/stream برای دانلود فایل ZIP مخرب لینک شده‌است.
  
  لازم به ذکر است که موفقیتِ این تلاش برای حمله، به مهندسی اجتماعی و تعامل با کاربر متکی است. هنگامی که کاربر روی لینک ایمیل ارسال شده کلیک می‌کند، صفحه HTML یک فایل ZIP تعبیه شده با یک فایل جاوا اسکریپت مبهم را برای او باز می‌کند. هنگامی که کاربر فایل ZIP را باز می‌کند و فایل جاوا اسکریپت را اجرا می‌کند، اسکریپت مذکور به hxxps://malparque[.]org/rest/restfuch[.]png متصل می‌شود و فایل ZIP دیگری را دانلود می‌کند که در قالب یک فایل PNG ظاهر می‌شود. 
  این فایل ZIP دوم، حاوی فایل‌های زیر مربوط به ابزار DAEMON است:
   
  - فایل   sptdintf.dll - این یک فایل قانونی است. برنامه‌های مختلف دیسک مجازی، از جمله DAEMON Tools و Alcohol 120%، از این فایلِ کتابخانه‌ی پیوند پویا (DLL) استفاده می‌کنند.
  - فایل  imgengine.dll – این یک فایل مخرب است که به منظور مبهم‌سازی، با Themida یا VMPProtected بسته‌بندی شده است. این فایل به اطلاعات موقعیت جغرافیایی هدف دسترسی پیدا می‌کند و سعی می‌کند اطلاعات اعتبارنامه و ثبت کلید را به سرقت ببرد.
  -  یک فایل اجرایی با نام تصادفی، که به نامِ «Disc Soft Bus Service Pro» که یک فایل قانونی است، تغییر نام یافته است. این فایل قانونی بخشی از DAEMON Tools Pro است و هر دو DLL را بارگیری می‌کند.

در نهایت، هنگامی که کاربر فایل اجرایی اصلی (فایل قانونی تغییر نام یافته) را اجرا می‌کند، DLL مخرب را از طریق بارگذاری جانبی DLL راه اندازی و بارگذاری می‌کند.
همانطور که قبلا ذکر شد، این فایل DLL به Mekotio، یک خانواده‌ی بدافزار از تروجان‌های بانکی که معمولاً در سیستم‌های ویندوز مستقر می‌شوند، نسبت داده می‌شود که از نیمه دوم سال ۲۰۱۶ صنایع آمریکای لاتین را هدف قرار داده‌اند. در ادامه، فایل جاوا اسکریپت مبهمی که در این حمله استفاده شده‌است را آورده‌ایم: 
   </br>
  <div align="center" style="text-align:center" >
  <img src="https://www.microsoft.com/security/blog/uploads/securityprod/2021/11/Fig5-ZIP-file.png" width="70%" alt=""/>
</div>
   
# استفاده از HTML smuggling در حملات هدفمند
حملات سایبری مختلف، ازجمله آن‌هایی که پیچیده‌تر و هدفمندتر هستند، از HTML smuggling به عنوان سلاح استفاده می‌کنند. برای مثال در ماه می سال 2021، مرکز اطلاعات تهدیدات مایکروسافت (MSTIC)، تحلیل مفصلی از یک حمله جدید و پیچیده که از طریق ارسال ایمیل توسط گروه تهدید روسی NOBELIUM رخ داده بود، ارائه کرد.
در این تحلیل اشاره شده‌است که این ایمیل، حاوی یک فایل html است که بعد از اینکه کاربر مورد نظر آن را باز می‌کند، از HTML smuggling برای دانلود فایل اصلی روی سیستم کاربر استفاده می‌کند.
  
در ماه سپتامبر، یک حمله ایمیلی به وقوع پیوست که از  HTML smuggling برای ارائه Trickbot (یک تروژان بانکی است که می‌تواند جزئیات مالی، اعتبار حساب و اطلاعات شناسایی شخصی (PII) را بدزد) استفاده می‌کرد. مایکروسافت این حمله Trickbot را به یک گروه مجرم سایبری نوظهو، به نام DEV-0193 نسبت می‌دهد.
  
همانطور که در عکس پایین مشاهده می‌کنید، در این حمله، مهاجم یک صفحه HTML ساخته شده ویژه را به شکل پیوستِ یک ایمیل که ادعا می‌کند یک گزارش تجاری است، ارسال می‌کند.
  </br>
  <div align="center" style="text-align:center" >
  <img src="https://www.microsoft.com/security/blog/uploads/securityprod/2021/11/Fig6-HTML-smuggling-Trickbot-page.png" width="60%" alt=""/>
</div>
  </br>
  هنگامی که کاربرِ هدف، پیوست HTML را در یک مرورگر وب باز می‌کند، یک فایل جاوا اسکریپت ساخته می‌شود و در پوشه پیش‌فرض دانلودهای سیستم هدف ذخیره می‌شود. این فایل جاوا اسکریپت، برای مقابله با کنترل‌های امنیتی آن سیستم، با رمز عبور محافظت می‌شود. بنابراین، کاربر باید برای باز کردن آن از رمز عبوری که در صفحه HTML پیوست‌شده قرار دارد، استفاده کند.
  </br>
  </br>
  <p align=center>
    <img src="https://www.microsoft.com/security/blog/uploads/securityprod/2021/11/Fig7a-JavaScript.png" width="50%" alt=""/>
    <img src="https://www.microsoft.com/security/blog/uploads/securityprod/2021/11/Fig7b-JavaScript.png" width="30%" alt=""/>
  </p>
  
  </br>
  هنگامی که کاربر، فایل جاوا اسکریپت را اجرا می‌کند، یک دستور PowerShell  که به‌صورت Base64 کدگذاری شده‌است شروع به اجرا شدن می‌کند  و سرور مهاجم را فراخوانی می‌کند تا Trickbot مذکور را دانلود کند. در ادامه، شمای این حمله آورده شده‌است.
  </br>
  </br>
  <div align="center" style="text-align:center" >
    <img src="https://www.microsoft.com/security/blog/uploads/securityprod/2021/11/Fig8-attack-chain-Trickbot-campaign.png" width="70%" alt=""/>
  </div>
  </br>
  گروه DEV-0193 پس از به خطر انداختن یک سازمان، به عنوان یک نقطه اساسی و فعال کننده برای حملات باج افزار بعدی عمل می‌کند. بنابراین، هنگامی که این گروه یک سازمان را به خطر بیاندازد، به احتمال زیاد یک حمله باج افزار به دنبال خواهد داشت.
  
  # دفاع در برابر تهدیداتی که از HTML smuggling استفاده می‌کنند
  راه‌حل‌های امنیتیِ سنتی، در برابر حملات HTML smuggling با چالش روبرو هستند. برای دفاع مؤثر در برابر این تکنیک مخفیانه، نیازمند دفاع در عمق صحیح هستیم.
  این نکته قابل توجه است که همیشه بهتر است یک حمله را در همان مراحل ابتدایی خنثی کرد. اما اگر یک تهدید بتواند از شکاف‌های امنیتی عبور کرده، به سیستم هدف نفوذ کند، کنترل‌های حفاظتی در نقطه پایانی باید بتوانند از اجرای حمله جلوگیری کنند.
  قبل از اینکه یک ایمیل به گیرنده تحویل داده شود، استفاده از یک محیط مجازی برای بررسی پیوندها و پیوست های موجود در آن ایمیل، محافظت در لحظه را در برابر HTML smuggling و سایر تهدیدات ایمیلی فراهم می‌کند. برای مثال، قواعدی که موارد زیر را بررسی می‌کنند،
  در شناسایی پیوست‌های HTMLی که حاوی بدافزاری هستند که منجر به  HTML smuggling می‌شوند، موفق بوده‌اند:
  
  - فایل ZIP پیوست‌شده، حاوی جاوا اسکریپت باشد.
  - فایل موجود در پیوست، با رمز عبور محافظت شده باش.
  - آشنایی با ساختار فایل‌ها و فولدربندی
  - یک فایل HTML که حاوی کد اسکریپت مشکوک باشد.
  - یک فایل HTML که کد Base64 را رمزگشایی می‌کند یا یک جاوا اسکریپت را مبهم می‌کند.
  
  

به‌عنوان مکانیزم‌های دفاعی دربرابر حملات، می‌توان اقدامات زیر را برای کاهش تأثیر تهدیداتی که از HTML smuggling استفاده می‌کنند، اعمال کرد:

  -  با تغییر برنامه پیش‌فرض برای اجرای فایل‌های js. و jse. از اجرای خودکار کدهای جاوا اسکریپت جلوگیری کنیم (مثلا در ویندوز، این فایل‌ها با notepad.exe یا ویرایشگرهای متن دیگر اجرا شوند).
  - بررسی تنظیمات فیلتر ایمیل به منظور اطمینان از اینکه ایمیل‌های جعلی، هرزنامه‌ها و ایمیل‌های دارای بدافزار را مسدود می‌کنند.
  -  بررسی فایروال و پروکسی محیط برای جلوگیری سرورها از ایجاد اتصال دلخواه به اینترنت به منظور مرور و دانلود فایل‌. این محدودیت‌ها موجب جلوگیری از دانلود بدافزار و فعالیت خط فرمان می‌شود.

 
# منبع
   https://www.microsoft.com/security/blog/2021/11/11/html-smuggling-surges-highly-evasive-loader-technique-increasingly-used-in-banking-malware-targeted-attacks/

  
